<!-- PRODUCTION PACKAGE: Delivery (saved addresses + redirect) -->

<!-- 1) assets/popups/set-your-address.html -->
<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Set Alamat Penghantaran</title>
  <link rel="stylesheet" href="../tailwind.min.css" />
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="max-w-md mx-auto p-4 flex items-center gap-3">
    <a href="../../index.html" class="w-9 h-9 grid place-items-center rounded-full ring-1 ring-gray-300" aria-label="Kembali">←</a>
    <h1 class="text-lg font-semibold">Set Alamat</h1>
  </header>

  <main class="max-w-md mx-auto p-4 grid gap-4">
    <!-- Saved addresses -->
    <section class="bg-white rounded-2xl ring-1 ring-gray-200 p-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-base">Alamat Tersimpan</h2>
        <button id="clearAll" class="text-[11px] font-semibold text-rose-600 hover:underline">Padam Semua</button>
      </div>
      <ul id="savedList" class="divide-y mt-2 empty:hidden">
        <!-- Diisi oleh delivery.js -->
      </ul>
      <div id="savedEmpty" class="text-xs text-gray-500 mt-2">Tiada alamat tersimpan.</div>
      <template id="savedRow">
        <li class="py-2 flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="flex items-center gap-2">
              <div class="font-medium text-sm label"></div>
              <span class="defaultBadge hidden text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 ring-1 ring-amber-200">Lalai</span>
            </div>
            <div class="text-xs text-gray-500 address"></div>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <button class="use px-2 py-1 rounded-lg bg-blue-600 text-white text-[11px] font-semibold">Guna</button>
            <button class="edit px-2 py-1 rounded-lg ring-1 ring-gray-300 text-[11px] font-semibold">Edit</button>
            <button class="star px-2 py-1 rounded-lg ring-1 ring-amber-300 text-[11px] font-semibold">Lalai</button>
            <button class="del px-2 py-1 rounded-lg ring-1 ring-gray-300 text-[11px] font-semibold">Padam</button>
          </div>
        </li>
      </template>
    </section>

    <!-- New address form -->
    <section class="bg-white rounded-2xl ring-1 ring-gray-200 p-4">
      <h2 class="font-semibold text-base mb-2">Alamat Baharu</h2>
      <form id="addressForm" action="../../index.html" method="get" class="grid gap-3">
        <label class="grid gap-1">
          <span class="text-sm font-medium">Label (contoh: Rumah/Pejabat)</span>
          <input id="label" name="label" class="rounded-lg ring-1 ring-gray-300 px-3 py-2" placeholder="Rumah" autocomplete="shipping address-line1" />
        </label>
        <label class="grid gap-1">
          <span class="text-sm font-medium">Alamat 1</span>
          <input id="addr1" required class="rounded-lg ring-1 ring-gray-300 px-3 py-2" placeholder="No 12, Jalan Aman" autocomplete="shipping address-line1" />
        </label>
        <label class="grid gap-1">
          <span class="text-sm font-medium">Alamat 2 (pilihan)</span>
          <input id="addr2" class="rounded-lg ring-1 ring-gray-300 px-3 py-2" placeholder="Taman/Apartment" autocomplete="shipping address-line2" />
        </label>
        <div class="grid grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm font-medium">Bandar</span>
            <input id="city" required class="rounded-lg ring-1 ring-gray-300 px-3 py-2" placeholder="Kota Bharu" autocomplete="address-level2" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm font-medium">Poskod</span>
            <input id="postcode" required pattern="\\d{5}" title="5 digit" class="rounded-lg ring-1 ring-gray-300 px-3 py-2" placeholder="15000" inputmode="numeric" />
          </label>
        </div>
        <label class="grid gap-1">
          <span class="text-sm font-medium">Negeri</span>
          <select id="state" class="rounded-lg ring-1 ring-gray-300 px-3 py-2">
            <option value="">Pilih negeri</option>
            <option>Kelantan</option><option>Kedah</option><option>Terengganu</option>
            <option>Pahang</option><option>Perak</option><option>Perlis</option>
            <option>Selangor</option><option>Johor</option><option>Melaka</option>
            <option>Negeri Sembilan</option><option>Sabah</option><option>Sarawak</option>
            <option>W.P. Kuala Lumpur</option><option>W.P. Putrajaya</option><option>W.P. Labuan</option>
          </select>
        </label>
        <label class="inline-flex items-center gap-2 mt-1">
          <input id="save" type="checkbox" class="accent-blue-600" checked />
          <span class="text-sm">Simpan alamat ini</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input id="makeDefault" type="checkbox" class="accent-blue-600" />
          <span class="text-sm">Jadikan alamat lalai</span>
        </label>

        <!-- Hidden field to pass composed address back to index.html -->
        <input type="hidden" name="address" id="addressHidden" />
        <input type="hidden" name="addressLabel" id="addressLabelHidden" />

        <button class="mt-2 w-full py-3 rounded-xl bg-blue-600 text-white font-semibold">Sahkan</button>
      </form>
    </section>
  </main>

  <script src="../js/delivery.js" defer></script>
</body>
</html>

<!-- 2) assets/js/delivery.js -->
<script type="text/plain" data-file="assets/js/delivery.js">// delivery.js — saved addresses (localStorage) + compose + redirect
(() => {
  const $ = (s, el = document) => el.querySelector(s);
  const list = $('#savedList');
  const rowTpl = $('#savedRow');
  const savedEmpty = $('#savedEmpty');
  const clearAll = $('#clearAll');

  const LS_KEY = 'savedAddresses';
  const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } };
  const save = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

  function renderSaved() {
    const items = load();
    list.innerHTML = '';
    if (!items.length) {
      savedEmpty.classList.remove('hidden');
    } else {
      savedEmpty.classList.add('hidden');
    }
    items.forEach((it, idx) => {
      const li = rowTpl.content.cloneNode(true);
      $('.label', li).textContent = it.label || 'Alamat';
      $('.address', li).textContent = it.address;
      $('.use', li).addEventListener('click', () => {
        const url = new URL('/index.html', location.origin);
        url.searchParams.set('address', it.address);
        if (it.label) url.searchParams.set('addressLabel', it.label);
        location.href = url.toString();
      });
      $('.del', li).addEventListener('click', () => {
        const arr = load();
        arr.splice(idx, 1);
        save(arr);
        renderSaved();
      });
      list.appendChild(li);
    });
  }

  clearAll?.addEventListener('click', () => { save([]); renderSaved(); });
  renderSaved();

  // Form handling
  const form = document.getElementById('addressForm');
  if (form) {
    form.addEventListener('submit', (e) => {
      // Compose address into single line
      const label = $('#label')?.value?.trim();
      const a1 = $('#addr1').value.trim();
      const a2 = $('#addr2').value.trim();
      const city = $('#city').value.trim();
      const state = $('#state').value.trim();
      const pc = $('#postcode').value.trim();

      const parts = [a1, a2, city, state, pc].filter(Boolean);
      const composed = parts.join(', ');

      // Set hidden fields before submit (GET → index.html?address=...)
      $('#addressHidden').value = composed;
      if (label) $('#addressLabelHidden').value = label;

      // Save to localStorage if checked
      if ($('#save')?.checked) {
        const arr = load();
        arr.unshift({ label, address: composed, createdAt: Date.now() });
        save(arr.slice(0, 20)); // keep last 20
      }
    });
  }
})();
</script>

<!-- 3) app.js snippet (Home) → address badge -->
<script type="text/plain" data-file="app.js (add this block)">/* Address badge (on Home) */
(() => {
  const params = new URLSearchParams(location.search);
  const address = params.get('address');
  const label = params.get('addressLabel');
  const badge = document.querySelector('[data-address-badge]');
  const text = document.querySelector('[data-address-text]');
  const clear = document.querySelector('[data-address-clear]');
  if (!badge || !text || !clear) return;

  if (address) {
    badge.classList.remove('hidden');
    text.textContent = label ? `${label}: ${address}` : address;
    clear.addEventListener('click', () => {
      const url = new URL(location.href);
      url.searchParams.delete('address');
      url.searchParams.delete('addressLabel');
      location.href = url.pathname; // drop query
    });
  } else {
    badge.classList.add('hidden');
  }
})();
</script>

<!-- 4) (optional) index.html — letak badge container di top card -->
<script type="text/plain" data-file="index.html (add inside top card)"><div class=\"mt-3 flex items-center gap-2 hidden\" data-address-badge>
  <span class=\"text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 ring-1 ring-blue-200\" data-address-text>Alamat dipilih</span>
  <button type=\"button\" class=\"text-[11px] font-semibold text-blue-600 hover:underline\" data-address-clear>Kosongkan</button>
</div>
</script>