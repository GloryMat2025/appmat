<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checkout – Line Items (BM/EN)</title>
<link rel="stylesheet" href="brand.css">
<style>
  :root{ --bg:#0f172a; --card:#0b1020; --muted:#94a3b8; --fg:#e5e7eb; --ok:#22c55e; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f172a;color:var(--fg)}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0c1422)}
  h1{margin:0;font-size:1.05rem}
  .right{display:flex;gap:10px;align-items:center}
  .pill{border:1px solid #223045;border-radius:999px;padding:6px 10px;background:#0c1627;color:#cfe7ff;cursor:pointer;user-select:none}
  .pill.active{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#07131c;border:0;font-weight:800}
  .wrap{max-width:980px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .section{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .items{display:flex;flex-direction:column;gap:10px}
  .item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid #1f2937;border-radius:10px;background:#0a1322}
  .thumb{width:64px;height:48px;background:#0b1424;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .name{font-weight:800}
  .mods{color:#cbd5e1;font-size:.88rem}
  .price{font-weight:800}
  .del{cursor:pointer;border:0;background:#1b2436;color:#fca5a5;border:1px solid #3b1e24;padding:6px 10px;border-radius:8px}
  .summary{display:flex;flex-direction:column;gap:8px}
  .line{display:flex;justify-content:space-between;align-items:center}
  .total{font-size:1.1rem;font-weight:900}
  .btn.primary{width:100%;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#07131c;border:0;font-weight:800}
  .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.35)}
</style>
</head>
<body>
  <header>
    <h1 data-i18n="checkout.title">Checkout</h1>
    <div class="right">
      <div class="pill active" id="langEN">EN</div>
      <div class="pill" id="langBM">BM</div>
    </div>
  </header>

  <div class="wrap">
    <div class="section" style="grid-column: 1 / span 2;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Items</strong>
        <span id="cartCount">0</span>
      </div>
      <div id="items" class="items"></div>
    </div>

    <div class="section">
      <div class="line"><span>Subtotal</span><span id="subTotal">—</span></div>
      <div class="line"><span>Delivery</span><span id="deliveryFee">—</span></div>
      <div class="line"><span>Discount</span><span id="discountAmt">—</span></div>
      <div class="line total"><span>Total</span><span id="grandTotal">—</span></div>
      <button id="payBtn" class="btn primary" disabled data-i18n="checkout.pay_now">Pay Now</button>
    </div>
  </div>

<script src="i18n.loader.js"></script>
<script>
I18NLoader.init({ defaultLang:'en', fallback:'en', sources:{ en:'i18n/en.json', bm:'i18n/bm.json' } });

const PRODUCTS_URL='products_min.json', PRICEBOOK_URL='pricebook.csv', INVENTORY_URL='inventory.csv', MODS_URL='modifiers.json';
const CART_KEY='demo.cart'; const DEFAULT_OUTLET='JOH01';
const fmtMYR = n => new Intl.NumberFormat('ms-MY',{style:'currency',currency:'MYR'}).format(n||0);
const $=s=>document.querySelector(s);
function readJSON(k, fb=null){ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? fb; }catch{ return fb; } }

let PRODUCTS=[], PRICEBOOK=[], INVENTORY=[], MODS=[];
function parseCSV(text){
  const lines=text.trim().split(/\r?\n/); if(!lines.length) return [];
  const hdrs=lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).filter(Boolean).map(line=>{
    const cols=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,''));
    const o={}; hdrs.forEach((h,i)=> o[h]=(cols[i]??'').trim());
    if('price' in o) o.price=Number(o.price||0);
    if('on_hand' in o) o.on_hand=Number(o.on_hand||0);
    if('safety_stock' in o) o.safety_stock=Number(o.safety_stock||0);
    return o;
  });
}
function outletId(){ try{ const o=JSON.parse(localStorage.getItem('app.outlet')||'null'); return o?.id||DEFAULT_OUTLET; }catch{ return DEFAULT_OUTLET; } }
function effectivePrice(pid,outlet){
  const today=new Date().toISOString().slice(0,10);
  const rows=PRICEBOOK.filter(r=>r.outlet_id===outlet && r.product_id===pid);
  for(const r of rows){ const s=r.start_date||'0000-01-01', e=r.end_date||'9999-12-31';
    const avail=String(r.is_available||'true').toLowerCase()==='true';
    if(s<=today && today<=e) return {price:r.price,currency:r.currency||'MYR',available:avail};
  }
  if(rows[0]) return {price:rows[0].price,currency:rows[0].currency||'MYR',available:String(rows[0].is_available||'true').toLowerCase()==='true'};
  return {price:null,currency:'MYR',available:true};
}
function resolveModsPrice(mods){
  let sum=0;
  if(!mods) return 0;
  const byId={}; for(const g of MODS) byId[g.id]=g;
  for(const [gid, oid] of Object.entries(mods)){
    const g=byId[gid]; if(!g) continue;
    const opt=(g.options||[]).find(o=>o.id===oid); if(!opt) continue;
    sum += Number(opt.price_delta||0);
  }
  return sum;
}
function renderItems(){
  const CART = readJSON(CART_KEY, []);
  $('#cartCount').textContent = CART.reduce((n,x)=>n+(Number(x.qty)||0),0);
  const host=$('#items');
  if(!CART.length){ host.innerHTML = `<div class="muted">${I18NLoader.t('common.empty')}</div>`; return; }
  const oId = outletId();

  host.innerHTML = CART.map(({id, qty, mods})=>{
    const p = PRODUCTS.find(x=>x.id===id) || {};
    const name = I18NLoader.lang==='bm' ? (p.name_bm || p.name_en || p.name || id) : (p.name_en || p.name_bm || p.name || id);
    const eprice=effectivePrice(id,oId);
    const base = (eprice.price!=null? eprice.price : (p.price ?? p.base_price ?? 0));
    const modDelta = resolveModsPrice(mods);
    const unit = base + modDelta;
    const img = p.image || (p.images && p.images[0]);
    const modsText = Object.entries(mods||{}).map(([gid, oid])=>{
      const g = MODS.find(x=>x.id===gid); if(!g) return '';
      const gName = I18NLoader.lang==='bm' ? (g.name_bm || g.name_en) : (g.name_en || g.name_bm);
      const opt = (g.options||[]).find(o=>o.id===oid) || {};
      const oName = I18NLoader.lang==='bm' ? (opt.name_bm || opt.name_en) : (opt.name_en || opt.name_bm);
      const d = opt.price_delta ? ` + ${fmtMYR(opt.price_delta)}` : '';
      return `${gName}: ${oName}${d}`;
    }).filter(Boolean).join(' · ');

    return `
      <div class="item" data-id="${id}" data-mods='${JSON.stringify(mods||{})}'>
        <div class="thumb">${img ? `<img alt="${name}" src="${img}" onerror="this.remove()">` : '<span>—</span>'}</div>
        <div>
          <div class="name">${name}</div>
          ${modsText ? `<div class="mods">${modsText}</div>` : ''}
          <div class="mods muted" style="margin-top:4px">x ${qty}</div>
        </div>
        <div style="text-align:right">
          <div class="price">${fmtMYR(unit)}</div>
          <div class="muted">${fmtMYR(unit*qty)}</div>
          <button class="del" style="margin-top:6px">Remove</button>
        </div>
      </div>`;
  }).join('');

  computeTotals();
}
function computeTotals(){
  const CART = readJSON(CART_KEY, []);
  const oId = outletId();
  let subtotal=0;
  for(const {id, qty, mods} of CART){
    const p = PRODUCTS.find(x=>x.id===id) || {};
    const base = (effectivePrice(id,oId).price ?? p.price ?? p.base_price ?? 0);
    const unit = base + resolveModsPrice(mods);
    subtotal += unit * (Number(qty)||0);
  }
  const delivery = subtotal>0 ? 5.00 : 0.00;
  const discount = 0.00;
  const total = Math.max(0, subtotal + delivery - discount);
  $('#subTotal').textContent = fmtMYR(subtotal);
  $('#deliveryFee').textContent = fmtMYR(delivery);
  $('#discountAmt').textContent = fmtMYR(discount);
  $('#grandTotal').textContent = fmtMYR(total);
  // Enable pay if cart has items (outlet/address checks can be added similarly)
  $('#payBtn').disabled = !(CART.length);
}
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    const [pr,pb,iv,md] = await Promise.all([fetch(PRODUCTS_URL), fetch(PRICEBOOK_URL), fetch(INVENTORY_URL), fetch(MODS_URL)]);
    PRODUCTS = await pr.json(); PRICEBOOK = parseCSV(await pb.text());
    INVENTORY = parseCSV(await iv.text()); MODS = (await md.json()).modifier_groups||[];
  }catch(e){ console.error(e); }
  renderItems();
});
window.addEventListener('i18n:change', ()=> renderItems());
document.getElementById('items').addEventListener('click', (e)=>{
  const row = e.target.closest('.item'); if(!row) return;
  if(e.target.classList.contains('del')){
    const id = row.getAttribute('data-id');
    const mods = JSON.parse(row.getAttribute('data-mods')||'{}');
    const CART = readJSON(CART_KEY, []);
    const idx = CART.findIndex(x => x.id===id && JSON.stringify(x.mods||{})===JSON.stringify(mods||{}));
    if(idx>=0){ CART.splice(idx,1); localStorage.setItem(CART_KEY, JSON.stringify(CART)); renderItems(); }
  }
});
</script>
</body>
</html>
