<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Products – Full (BM/EN, Categories + Stock)</title>
<style>
  :root{
    --bg:#0f172a; --card:#0b1020; --muted:#94a3b8; --fg:#e5e7eb;
    --brand: var(--brand, #3a6d9b);
    --brand2: var(--brand-2, #2E7AA6);
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1222,#0f172a);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0c1422)}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:28px;height:28px;object-fit:contain}
  h1{margin:0;font-size:1.05rem;letter-spacing:.2px}
  .right{display:flex;gap:10px;align-items:center}
  .pill{border:1px solid #223045;border-radius:999px;padding:6px 10px;background:#0c1627;color:#cfe7ff;cursor:pointer;user-select:none}
  .pill.active{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#07131c;border:0;font-weight:800}
  .cart{position:relative;display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid #223045;border-radius:10px;background:#0c1627}
  .badge{min-width:22px;height:22px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand2));display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#07131c;font-size:.85rem}
  .wrap{max-width:1120px;margin:16px auto;padding:0 16px}
  .toolbar{display:grid;grid-template-columns:1fr;gap:10px;align-items:center;margin-bottom:12px}
  .tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
  .tab{white-space:nowrap;border:1px solid #223045;border-radius:999px;padding:8px 12px;background:#0c1627;color:#cfe7ff;cursor:pointer;user-select:none}
  .tab.active{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#07131c;border:0;font-weight:800}
  .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .search{flex:1;min-width:240px}
  .search input{width:100%;padding:10px 12px;border:1px solid #223045;border-radius:10px;background:#0c1627;color:#e5e7eb}
  .select{border:1px solid #223045;border-radius:10px;background:#0c1627;color:#cfe7ff;padding:10px 12px}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{background:linear-gradient(180deg,#0f172a,#0b1020);border:1px solid #1f2937;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .img{background:#0b1424;aspect-ratio:16/10;display:flex;align-items:center;justify-content:center;color:#7aa2c9;font-size:.9rem}
  .content{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:800}
  .price{font-weight:800}
  .muted{color:var(--muted);font-size:.92rem}
  .stock{font-size:.85rem;border:1px solid #243041;border-radius:8px;padding:2px 8px;display:inline-block}
  .stock.ok{background:#0f2b1b;border-color:#1b4d2d;color:#bbf7d0;font-weight:800}
  .stock.low{background:#3a2a0f;border-color:#5a4012;color:#fde68a;font-weight:800}
  .stock.none{background:#2a1620;border-color:#3b1e24;color:#fecaca;font-weight:800}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qty{display:inline-flex;align-items:center;border:1px solid #243041;border-radius:10px;overflow:hidden}
  .qty button{background:#0a1322;color:#dbeafe;border:0;width:36px;height:36px;font-weight:800;cursor:pointer}
  .qty input{width:48px;text-align:center;background:#0a1322;border:0;color:#e5e7eb;height:36px}
  .btn{border:1px solid #223045;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;background:#0c1627;color:#dbeafe}
  .btn.buy{background:linear-gradient(90deg, var(--ok), #a7f3d0);color:#06240f;border:0}
  .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.35)}
  footer{padding:14px;color:var(--muted);font-size:.9rem;text-align:center}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <img id="brandLogo" alt="Logo" src="" onerror="this.style.display='none'">
      <h1 data-i18n="title">Product Catalog</h1>
    </div>
    <div class="right">
      <div class="pill active" id="langEN">EN</div>
      <div class="pill" id="langBM">BM</div>
      <div class="cart" aria-label="Cart"><span data-i18n="common.cart">Cart</span><span class="badge" id="cartBadge">0</span></div>
    </div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="tabs" id="tabs"></div>
      <div class="filters">
        <div>Outlet: <code id="outletId">JOH01</code></div>
        <div class="search"><input id="q" data-i18n-placeholder="common.search_placeholder" placeholder="Search products…" /></div>
        <select id="sortSel" class="select">
          <option value="name_asc">A → Z</option>
          <option value="name_desc">Z → A</option>
          <option value="price_asc">Price ↑</option>
          <option value="price_desc">Price ↓</option>
        </select>
      </div>
    </div>
    <div id="products" class="grid" aria-live="polite"></div>
  </div>

  <footer>
    Data: <code>products.json</code>, <code>categories.json</code>, <code>pricebook.csv</code>, <code>inventory.csv</code>. 
    Configure logo URL via <code>localStorage.app.logoUrl</code>. Brand via CSS <code>--brand</code> & <code>--brand-2</code>.
  </footer>

<script src="i18n.loader.js"></script>
<script>
// i18n init
I18NLoader.init({ defaultLang: 'en', fallback: 'en', sources: { en: 'i18n/en.json', bm: 'i18n/bm.json' } });
I18NLoader.extend('en', { title: 'Product Catalog' });
I18NLoader.extend('bm', { title: 'Katalog Produk' });

// Data endpoints (adjust to your paths)
const DATA_URL = 'products_min.json';
const CAT_URL = 'categories.json';
const PRICEBOOK_URL = 'pricebook.csv';
const INVENTORY_URL = 'inventory.csv';
const DEFAULT_OUTLET = 'JOH01';

// Helpers
const fmtMYR = n => new Intl.NumberFormat('ms-MY',{style:'currency',currency:'MYR'}).format(n||0);
const $ = s => document.querySelector(s);
function slugify(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]+/g,''); }
function shortTxt(s){ if(!s) return ''; const t=String(s).trim(); const d=t.indexOf('.'); return d>0&&d<120? t.slice(0,d+1): (t.length>120? t.slice(0,117)+'…': t); }

// Logo (optional)
(function(){ try{ const u = JSON.parse(localStorage.getItem('app.logoUrl')||'null'); if(u) document.getElementById('brandLogo').src = u; }catch(_){} })();

/* Cart */
const CART_KEY = 'demo.cart';
const Cart = {
  _r(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { return []; } },
  _w(v){ localStorage.setItem(CART_KEY, JSON.stringify(v)); badge(); },
  add(id, qty=1){ const list=this._r(); const i=list.findIndex(x=>x.id===id); if(i>=0) list[i].qty=Math.min(999,list[i].qty+qty); else list.push({id,qty}); this._w(list); },
  count(){ return this._r().reduce((n,x)=>n+(Number(x.qty)||0),0); }
};
function badge(){ $('#cartBadge').textContent = Cart.count(); }

/* CSV Parser */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const hdrs = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).filter(Boolean).map(line=>{
    const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,''));
    const o = {};
    hdrs.forEach((h,i)=> o[h] = (cols[i]??'').trim());
    if('price' in o) o.price = Number(o.price||0);
    if('on_hand' in o) o.on_hand = Number(o.on_hand||0);
    if('safety_stock' in o) o.safety_stock = Number(o.safety_stock||0);
    return o;
  });
}

/* Data stores */
let PRODUCTS = [];
let CATS = [];
let PRICEBOOK = [];
let INVENTORY = [];
let activeCat = 'all';

/* Outlet */
function outletId(){
  try{ const o = JSON.parse(localStorage.getItem('app.outlet')||'null'); return o?.id || DEFAULT_OUTLET; }
  catch{ return DEFAULT_OUTLET; }
}

/* Price/Inventory lookup */
function effectivePrice(productId, outlet){
  const today = new Date().toISOString().slice(0,10);
  const rows = PRICEBOOK.filter(r => r.outlet_id===outlet && r.product_id===productId);
  for(const r of rows){
    const start = r.start_date || '0000-01-01';
    const end   = r.end_date   || '9999-12-31';
    const avail = String(r.is_available||'true').toLowerCase() === 'true';
    if(start <= today && today <= end) return { price:r.price, currency:r.currency||'MYR', available:avail };
  }
  if(rows[0]) return { price: rows[0].price, currency: rows[0].currency||'MYR', available:String(rows[0].is_available||'true').toLowerCase()==='true' };
  return { price:null, currency:'MYR', available:true };
}
function stockInfo(productId, outlet){
  const r = INVENTORY.find(x => x.outlet_id===outlet && x.product_id===productId);
  if(!r) return { on_hand:null, safety_stock:null };
  return { on_hand: Number(r.on_hand||0), safety_stock: Number(r.safety_stock||0) };
}

/* Category helpers */
function productCategorySlug(p){
  if(p.category_id){ const cat = CATS.find(c => c.id===p.category_id); if(cat) return cat.slug; }
  if(p.category){ return slugify(p.category); }
  if(p.region){ return slugify(p.region); }
  return 'uncategorized';
}
function renderTabs(){
  const tabs = $('#tabs');
  const uniqueSlugs = new Set(['all']);
  for(const p of PRODUCTS) uniqueSlugs.add(productCategorySlug(p));
  const list = CATS.filter(c => uniqueSlugs.has(c.slug)).slice().sort((a,b) => (a.sort_order||999)-(b.sort_order||999));
  const ensureAll = CATS.find(c => c.slug==='all') || { slug:'all', name_en:'All', name_bm:'Semua' };
  const final = [ensureAll, ...list.filter(c=>c.slug!=='all')];
  tabs.innerHTML = final.map(c => {
    const name = I18NLoader.lang==='bm' ? (c.name_bm || c.name_en || c.slug) : (c.name_en || c.name_bm || c.slug);
    const act = (c.slug === activeCat) ? 'tab active' : 'tab';
    return `<div class="${act}" data-slug="${c.slug}">${name}</div>`;
  }).join('');
}

/* Sorting */
function applySort(list){
  const v = $('#sortSel').value;
  const isBM = I18NLoader.lang==='bm';
  const nameKey = isBM ? 'name_bm' : 'name_en';
  if(v==='name_asc')  return list.sort((a,b)=> (a[nameKey]||'').localeCompare(b[nameKey]||''));
  if(v==='name_desc') return list.sort((a,b)=> (b[nameKey]||'').localeCompare(a[nameKey]||''));
  if(v==='price_asc') return list.sort((a,b)=> (a._effPrice) - (b._effPrice));
  if(v==='price_desc')return list.sort((a,b)=> (b._effPrice) - (a._effPrice));
  return list;
}

/* Stock badge */
function stockBadge(inv){
  if(inv.on_hand==null) return '';
  const t = I18NLoader;
  if(inv.on_hand <= 0) return `<span class="stock none">${t.t('common.out_of_stock')}</span>`;
  if(inv.safety_stock!=null && inv.on_hand <= inv.safety_stock) return `<span class="stock low">${t.t('common.low_stock')}: ${inv.on_hand}</span>`;
  return `<span class="stock ok">${t.t('common.in_stock')}: ${inv.on_hand}</span>`;
}

/* Card */
function card(p){
  const isBM = I18NLoader.lang==='bm';
  const name = p[isBM?'name_bm':'name_en'] || p.name || '';
  const short = p[isBM?'short_desc_bm':'short_desc_en'] || p.short_desc || p[isBM?'desc_bm':'desc_en'] || '';
  const long = p[isBM?'long_desc_bm':'long_desc_en'] || p.long_desc || p[isBM?'desc_bm':'desc_en'] || '';
  const img = p.image || (p.images && p.images[0]);
  const oId = outletId();
  const eprice = effectivePrice(p.id, oId);
  const inv = stockInfo(p.id, oId);
  const canBuy = eprice.available && (inv.on_hand==null || inv.on_hand>0);
  const price = eprice.price!=null? eprice.price : (p.price ?? p.base_price ?? 0);
  const imgEl = img ? `<img alt="${name}" src="${img}" style="width:100%;height:100%;object-fit:cover" onerror="this.outerHTML='<div class=&quot;img&quot;>No Image</div>'">` : `<div class="img">No Image</div>`;
  return `
  <article class="card" data-id="${p.id}" data-canbuy="${canBuy}">
    ${imgEl}
    <div class="content">
      <div class="name">${name}</div>
      <div class="price">${fmtMYR(price)} ${!eprice.available ? `<span class="stock none">${I18NLoader.t('common.unavailable')}</span>`:''} ${stockBadge(inv)}</div>
      <p class="muted">${shortTxt(short)}</p>
      ${long ? `<details><summary data-i18n="common.more_details">${I18NLoader.t('common.more_details')}</summary><div class="muted" style="margin-top:6px">${long}</div></details>`:''}
      <div class="actions">
        <div class="qty" aria-label="Quantity">
          <button class="qminus" aria-label="Decrease">−</button>
          <input class="qinput" type="number" value="1" min="1" max="99" inputmode="numeric" />
          <button class="qplus" aria-label="Increase">+</button>
        </div>
        <button class="btn" data-action="add" ${!canBuy?'disabled':''} data-i18n="common.add_to_cart">${I18NLoader.t('common.add_to_cart')}</button>
        <button class="btn buy" data-action="buy" ${!canBuy?'disabled':''} data-i18n="common.buy_now">${I18NLoader.t('common.buy_now')}</button>
      </div>
    </div>
  </article>`;
}

/* Render */
function render(){
  $('#outletId').textContent = outletId();
  renderTabs();
  const q = ($('#q').value || '').trim().toLowerCase();
  const oId = outletId();

  const enriched = PRODUCTS.map(p => {
    const eprice = effectivePrice(p.id, oId);
    const inv = stockInfo(p.id, oId);
    const price = eprice.price!=null? eprice.price : (p.price ?? p.base_price ?? 0);
    return Object.assign({}, p, { _effPrice: price, _inv: inv, _avail: eprice.available });
  });

  const filtered = enriched.filter(p => {
    const inCat = (activeCat==='all') || (productCategorySlug(p) === activeCat);
    const txt = [p.name, p.name_en, p.name_bm, p.short_desc, p.short_desc_en, p.short_desc_bm, p.long_desc, p.long_desc_en, p.long_desc_bm, p.desc_en, p.desc_bm].filter(Boolean).join(' ').toLowerCase();
    const inSearch = !q || txt.includes(q);
    return inCat && inSearch;
  });

  const sorted = applySort(filtered.slice());
  $('#products').innerHTML = sorted.map(card).join('');
  I18NLoader.apply();
  badge();
}

/* Init */
(async function init(){
  try {
    const [pr, cr, pb, inv] = await Promise.all([
      fetch(DATA_URL), fetch(CAT_URL), fetch(PRICEBOOK_URL), fetch(INVENTORY_URL)
    ]);
    PRODUCTS = await pr.json();
    CATS = await cr.json();
    PRICEBOOK = parseCSV(await pb.text());
    INVENTORY = parseCSV(await inv.text());
    render();
  } catch (e) {
    console.error(e);
    document.getElementById('products').innerHTML = `<div class="muted" data-i18n="common.empty">${I18NLoader.t('common.empty')}</div>`;
  }
})();

/* Events */
document.getElementById('tabs').addEventListener('click', (e) => {
  const t = e.target.closest('.tab');
  if(!t) return;
  activeCat = t.getAttribute('data-slug');
  render();
});
document.getElementById('q').addEventListener('input', render);
document.getElementById('sortSel').addEventListener('change', render);
document.getElementById('products').addEventListener('click', (e)=>{
  const card = e.target.closest('.card'); if(!card) return;
  const id = card.getAttribute('data-id');
  const canBuy = card.getAttribute('data-canbuy') === 'true';
  const qtyInput = card.querySelector('.qinput');
  const getQty = () => Math.max(1, Math.min(99, parseInt(qtyInput.value || '1', 10)));
  if(e.target.classList.contains('qminus')) qtyInput.value = Math.max(1, getQty()-1);
  if(e.target.classList.contains('qplus'))  qtyInput.value = Math.min(99, getQty()+1);
  const action = e.target.getAttribute('data-action');
  if(action === 'add' && canBuy){ const q=getQty(); Cart.add(id,q); const name = card.querySelector('.name')?.textContent || 'item'; toast(I18NLoader.t('common.added_to_cart', { count: q, name })); }
  if(action === 'buy' && canBuy){ const q=getQty(); Cart.add(id,q); toast(I18NLoader.t('common.proceed_checkout'),'ok'); }
});

// Re-apply on language change
window.addEventListener('i18n:change', render);

// Toast
function toast(msg, type){
  const t=document.createElement('div'); t.textContent=msg;
  t.style.position='fixed'; t.style.right='14px'; t.style.bottom='14px'; t.style.maxWidth='70vw';
  t.style.padding='10px 12px'; t.style.borderRadius='10px'; t.style.fontWeight='700'; t.style.border='1px solid #223045';
  t.style.background = type==='ok' ? 'linear-gradient(90deg, var(--ok), #a7f3d0)' : 'linear-gradient(90deg, var(--brand), var(--brand2))';
  t.style.color='#06131a'; t.style.boxShadow='0 8px 24px rgba(0,0,0,.35)';
  document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0'; t.style.transition='opacity .3s';}, 1200); setTimeout(()=>t.remove(), 1550);
}
</script>
</body>
</html>
