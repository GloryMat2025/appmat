<!doctype html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feature Flags</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full text-slate-800">
  <header class="border-b bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold">Feature Flags</h1>
      <div class="flex items-center gap-2">
        <button id="btnExport" class="px-3 py-1.5 rounded-lg border">Export JSON</button>
        <label class="px-3 py-1.5 rounded-lg border cursor-pointer">Import JSON <input id="fileImport" type="file" accept="application/json" class="hidden"></label>
        <button id="btnNew" class="px-3 py-1.5 rounded-lg bg-sky-600 text-white">New flag</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <h2 class="text-sm font-semibold mb-3">Evaluate</h2>
      <div class="grid md:grid-cols-5 gap-3 items-end">
        <div><label class="text-sm">Env</label><select id="env" class="w-full border rounded-lg px-2 py-1"><option>prod</option><option>staging</option><option>dev</option></select></div>
        <div><label class="text-sm">User ID</label><input id="uid" class="w-full border rounded-lg px-3 py-2" placeholder="u123"></div>
        <div><label class="text-sm">Email</label><input id="email" class="w-full border rounded-lg px-3 py-2" placeholder="user@example.com"></div>
        <div><label class="text-sm">Attrs (JSON)</label><input id="attrs" class="w-full border rounded-lg px-3 py-2" placeholder='{"plan":"pro"}'></div>
        <div><button id="btnEvalAll" class="w-full px-3 py-2 rounded-lg border">Evaluate all</button></div>
      </div>
      <pre id="evalOut" class="mt-3 text-xs bg-slate-50 p-3 rounded-lg overflow-auto">—</pre>
    </section>

    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold">Flags</h2>
        <div class="text-xs text-slate-500">Hotkey: <span class="kbd">n</span> new flag</div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
      <p id="emptyMsg" class="text-sm text-slate-500">No flags yet.</p>
    </section>
  </main>

  <dialog id="dlg" class="rounded-2xl p-0 w-[720px] max-w-[92vw]">
    <form method="dialog" class="p-4 space-y-3">
      <h3 class="text-base font-semibold" id="dlgTitle">New flag</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div><label class="text-sm">Key</label><input id="fKey" class="w-full border rounded-lg px-3 py-2" placeholder="new_dashboard"></div>
        <div><label class="text-sm">Note</label><input id="fNote" class="w-full border rounded-lg px-3 py-2" placeholder="Short description"></div>
      </div>
      <div class="grid md:grid-cols-3 gap-3">
        <!-- env cards will be filled by JS -->
        <div class="border rounded-lg p-3" data-envcard="prod"></div>
        <div class="border rounded-lg p-3" data-envcard="staging"></div>
        <div class="border rounded-lg p-3" data-envcard="dev"></div>
      </div>
      <div class="flex justify-end gap-2">
        <button class="px-3 py-1.5 rounded-lg border">Cancel</button>
        <button id="btnSave" class="px-3 py-1.5 rounded-lg bg-sky-600 text-white">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    const $ = id => document.getElementById(id);
    const list = $('list');
    const emptyMsg = $('emptyMsg');
    const dlg = $('dlg');

    function envCardHtml(env){
      return \`
        <div class="font-medium text-sm mb-2">\${env.toUpperCase()}</div>
        <label class="inline-flex items-center gap-2 text-sm mb-2"><input type="checkbox" class="env_on" data-env="\${env}"> Enabled</label>
        <label class="block text-sm mb-1">Rollout %</label>
        <input type="number" class="env_pct w-full border rounded-lg px-3 py-2" data-env="\${env}" min="0" max="100" value="0">
        <label class="block text-sm mt-2 mb-1">Allowlist (comma)</label>
        <input type="text" class="env_allow w-full border rounded-lg px-3 py-2" data-env="\${env}" placeholder="u1,u2,email@example.com">
        <label class="block text-sm mt-2 mb-1">Blocklist (comma)</label>
        <input type="text" class="env_block w-full border rounded-lg px-3 py-2" data-env="\${env}" placeholder="">
        <label class="block text-sm mt-2 mb-1">Attr rules JSON</label>
        <input type="text" class="env_attrs w-full border rounded-lg px-3 py-2" data-env="\${env}" placeholder='{"plan":["pro"]}'>
      \`;
    }
    document.querySelector('[data-envcard="prod"]').innerHTML = envCardHtml('prod');
    document.querySelector('[data-envcard="staging"]').innerHTML = envCardHtml('staging');
    document.querySelector('[data-envcard="dev"]').innerHTML = envCardHtml('dev');

    async function fetchFlags(){
      const r = await fetch('/api/flags', { credentials:'include' });
      const arr = await r.json();
      render(arr);
    }
    function render(arr){
      list.innerHTML = '';
      if (!arr.length){ emptyMsg.classList.remove('hidden'); return; }
      emptyMsg.classList.add('hidden');
      arr.forEach(f => list.appendChild(card(f)));
    }
    function card(f){
      const el = document.createElement('div');
      el.className = 'border rounded-xl p-3 bg-white';
      el.innerHTML = \`
        <div class="flex items-center justify-between">
          <div>
            <div class="font-mono font-medium">\${f.key}</div>
            <div class="text-xs text-slate-500">\${f.note||''}</div>
          </div>
          <div class="text-xs text-slate-500">Updated \${new Date(f.updatedAt).toLocaleString()} by \${f.updatedBy||'—'}</div>
        </div>
        <div class="grid md:grid-cols-3 gap-3 mt-3">
          \${['prod','staging','dev'].map(env=> rowEnv(env, f.env?.[env]||{})).join('')}
        </div>
        <div class="mt-3 flex items-center gap-2">
          <button class="px-3 py-1.5 rounded-lg border" data-act="edit">Edit</button>
          <button class="px-3 py-1.5 rounded-lg border text-red-600" data-act="del">Delete</button>
          <span class="ml-auto text-xs text-slate-500">Test user: <input class="border rounded px-1 py-0.5 text-xs w-36" data-act="uid" placeholder="user id/email"> <button class="text-xs px-2 py-1 rounded-lg border" data-act="test">Eval</button> <span data-act="res"></span></span>
        </div>
      \`;
      el.querySelector('[data-act="edit"]').onclick = ()=> openEdit(f);
      el.querySelector('[data-act="del"]').onclick  = ()=> delFlag(f.key);
      el.querySelector('[data-act="test"]').onclick = async ()=>{
        const uid = el.querySelector('[data-act="uid"]').value.trim();
        const env = $('env').value;
        const r = await fetch(\`/api/flags/eval?key=\${encodeURIComponent(f.key)}&env=\${env}&userId=\${encodeURIComponent(uid)}\`);
        const j = await r.json();
        el.querySelector('[data-act="res"]').textContent = j.on ? '✔ on' : ('✖ off ('+j.reason+')');
        el.querySelector('[data-act="res"]').className = 'text-xs ' + (j.on ? 'text-emerald-700' : 'text-rose-600');
      };
      return el;
    }
    function rowEnv(env, cfg){
      return \`<div class="border rounded-lg p-3">
        <div class="text-xs">\${env.toUpperCase()}</div>
        <div class="mt-1"><span class="text-sm \${cfg.on?'text-emerald-700':'text-rose-600'}">\${cfg.on?'Enabled':'Disabled'}</span> · <span class="text-xs text-slate-500">\${cfg.pct||0}%</span></div>
        <div class="text-xs text-slate-500 mt-1">allow: \${(cfg.allow||[]).length}, block: \${(cfg.block||[]).length}</div>
      </div>\`;
    }

    let editing = null;
    function openEdit(f=null){
      editing = f;
      $('dlgTitle').textContent = f ? 'Edit flag' : 'New flag';
      $('fKey').value  = f?.key  || '';
      $('fKey').disabled = !!f;
      $('fNote').value = f?.note || '';
      ['prod','staging','dev'].forEach(env=>{
        const c = (f?.env?.[env]) || { on:false, pct:0, allow:[], block:[], attrs:{} };
        document.querySelector(\`.env_on[data-env="\${env}"]\`).checked = !!c.on;
        document.querySelector(\`.env_pct[data-env="\${env}"]\`).value = c.pct||0;
        document.querySelector(\`.env_allow[data-env="\${env}"]\`).value = (c.allow||[]).join(',');
        document.querySelector(\`.env_block[data-env="\${env}"]\`).value = (c.block||[]).join(',');
        document.querySelector(\`.env_attrs[data-env="\${env}"]\`).value = JSON.stringify(c.attrs||{});
      });
      dlg.showModal();
    }

    $('btnNew').addEventListener('click', ()=> openEdit(null));
    window.addEventListener('keydown', (e)=>{ if (e.key==='n') openEdit(null); });

    $('btnSave').addEventListener('click', async (e)=>{
      e.preventDefault();
      const env = {};
      for (const name of ['prod','staging','dev']){
        const on = document.querySelector(\`.env_on[data-env="\${name}"]\`).checked;
        const pct = parseInt(document.querySelector(\`.env_pct[data-env="\${name}"]\`).value, 10) || 0;
        const allow = document.querySelector(\`.env_allow[data-env="\${name}"]\`).value.split(',').map(x=>x.trim()).filter(Boolean);
        const block = document.querySelector(\`.env_block[data-env="\${name}"]\`).value.split(',').map(x=>x.trim()).filter(Boolean);
        let attrs = {};
        try { attrs = JSON.parse(document.querySelector(\`.env_attrs[data-env="\${name}"]\`).value || '{}'); } catch {}
        env[name] = { on, pct: Math.max(0, Math.min(100, pct)), allow, block, attrs };
      }
      const body = {
        key: $('fKey').value.trim(),
        note: $('fNote').value.trim(),
        env
      };
      const r = await fetch('/api/flags', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body) });
      if (!r.ok){ alert('Save failed'); return; }
      dlg.close(); fetchFlags();
    });

    async function delFlag(key){
      if (!confirm('Delete flag '+key+'?')) return;
      await fetch('/api/flags/'+encodeURIComponent(key), { method:'DELETE', credentials:'include' });
      fetchFlags();
    }

    $('btnExport').addEventListener('click', async ()=>{
      const r = await fetch('/api/flags', { credentials:'include' });
      const arr = await r.json();
      const blob = new Blob([JSON.stringify({ flags: arr }, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'feature_flags.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('fileImport').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      try{
        const obj = JSON.parse(text);
        const flags = obj.flags || [];
        for (const f of flags){
          await fetch('/api/flags', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(f) });
        }
        fetchFlags();
      } catch { alert('Invalid JSON'); }
      e.target.value = '';
    });

    $('btnEvalAll').addEventListener('click', async ()=>{
      let attrs = {}; try { attrs = JSON.parse($('attrs').value || '{}'); } catch {}
      const user = Object.assign({ id:$('uid').value.trim(), email:$('email').value.trim() }, attrs);
      const r = await fetch('/api/flags/eval_all', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ env:$('env').value, user }) });
      const j = await r.json();
      $('evalOut').textContent = JSON.stringify(j, null, 2);
    });

    fetchFlags();
  </script>
</body>
</html>
