<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin — Passwords</title>
<link rel="stylesheet" href="/assets/tailwind.min.css">
</head>
<body class="min-h-screen bg-gray-50">
  <header class="bg-white border-b p-3 flex items-center justify-between">
    <div class="font-semibold">Admin — Password Management</div>
    <nav class="text-sm">
      <a href="/assets/pages/dev/admin-login.html" class="text-blue-600">Login</a>
      <span class="mx-2">•</span>
      <a href="/assets/pages/dev/business-hours-settings.html" class="text-blue-600">Settings</a>
    </nav>
  </header>

  <main class="max-w-4xl mx-auto p-4 sm:p-6 space-y-4">
    <div class="rounded-xl border bg-white p-4">
      <div class="flex items-center justify-between mb-3">
        <h1 class="font-semibold">Users</h1>
        <button id="refresh" class="px-3 py-2 rounded-lg border">Refresh</button>
      </div>
      <div id="list" class="space-y-2"></div>
    </div>

    <div class="rounded-xl border bg-white p-4">
      <h2 class="font-semibold mb-2">Generate Reset Link</h2>
      <div class="flex items-center gap-2">
        <input id="email" type="email" placeholder="user@example.com" class="border rounded-lg px-3 py-2 w-full">
        <input id="ttl" type="number" min="5" value="60" class="border rounded-lg px-3 py-2 w-24" title="Minutes to expire">
        <label class="flex items-center gap-2 text-sm"><input id="sendEmail" type="checkbox"> Send email</label>
        <button id="gen" class="px-3 py-2 rounded-lg border">Create Link</button>
      </div>
      <div class="text-xs text-gray-500 mt-1">Optional base URL (if serving public files elsewhere):</div>
      <input id="baseUrl" type="text" placeholder="http://yourdomain.com/public" class="border rounded-lg px-3 py-2 w-full mt-1">
      <div id="result" class="text-sm text-gray-600 mt-2"></div>
    </div>
  </main>

<script type="module">
async function users(){
  const r = await fetch('/api/admin/users', { credentials:'include' });
  return r.json();
}
async function post(url, body){
  // CSRF double-submit (reuse audit-client logic here inline)
  const t = await fetch('/api/csrf', { credentials:'include' }).then(r=>r.json()).then(j=>j.token).catch(()=>'');
  const r = await fetch(url, {
    method:'POST', credentials:'include',
    headers:{'Content-Type':'application/json','X-CSRF-TOKEN': t || ''},
    body: JSON.stringify(body||{})
  });
  const j = await r.json().catch(()=>({ok:false}));
  if (!r.ok) throw new Error(j.error || 'Request failed');
  return j;
}
function el(tag, attrs={}, ...children){
  const x = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) (k==='class') ? x.className=v : x.setAttribute(k,v);
  for (const c of children) x.appendChild(typeof c==='string' ? document.createTextNode(c) : c);
  return x;
}
async function render(){
  const mount = document.getElementById('list');
  mount.innerHTML = '';
  const data = await users();
  if (!data.ok){ mount.textContent='Failed to load users (are you admin?)'; return; }
  data.users.forEach(u => {
    const row = el('div',{class:'flex items-center justify-between border rounded-lg p-3'},
      el('div',{},
        el('div',{class:'font-mono text-sm'}, u.email),
        el('div',{class:'text-xs text-gray-500'}, `${u.name||''} • ${u.role}`)
      ),
      el('div',{class:'text-xs'}, u.active ? 'Active' : 'Disabled')
    );
    mount.append(row);
  });
}
document.getElementById('refresh').onclick = render;
document.getElementById('gen').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const ttl = parseInt(document.getElementById('ttl').value||'60');
  const sendEmail = document.getElementById('sendEmail').checked;
  const baseUrl = document.getElementById('baseUrl').value.trim();
  const res = await post('/api/admin/users/reset-request', { email, ttlMinutes: ttl, sendEmail, baseUrl });
  const link = location.origin + '/public/assets/pages/dev/password-reset.html?email=' + encodeURIComponent(email) + '&token=' + encodeURIComponent(res.token);
  document.getElementById('result').innerHTML = 'Reset link (share securely): <a class="text-blue-600 underline" href="'+link+'">'+link+'</a><br><span class="text-xs text-gray-500">Expires at: '+ new Date(res.expiresAt).toLocaleString() +'</span>';
};
render();
</script>
</body>
</html>
