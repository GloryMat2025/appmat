<!doctype html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backups — Scheduler & Downloads</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full text-slate-800">
  <header class="border-b bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold">Backups</h1>
      <span class="text-xs rounded-full px-2 py-1 bg-emerald-100 text-emerald-700">admin</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <div class="flex items-center gap-2">
        <select id="type" class="border rounded-lg px-2 py-1">
          <option value="full">full</option>
          <option value="data">data</option>
        </select>
        <button id="btnRun" class="px-3 py-1.5 rounded-lg bg-sky-600 text-white">Run backup</button>
        <button id="btnRefresh" class="px-3 py-1.5 rounded-lg border">Refresh</button>
      </div>
      <div class="mt-3 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-600">
            <tr>
              <th class="py-2 pr-4">ID</th>
              <th class="py-2 pr-4">Created</th>
              <th class="py-2 pr-4">Type</th>
              <th class="py-2 pr-4">Size</th>
              <th class="py-2 pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <div class="flex items-center gap-2">
        <input id="every" type="number" class="border rounded-lg px-3 py-2" value="60">
        <span class="text-sm">minutes</span>
        <select id="stype" class="border rounded-lg px-2 py-1">
          <option value="full">full</option>
          <option value="data">data</option>
        </select>
        <button id="btnAddSch" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white">Add schedule</button>
      </div>
      <div class="mt-3 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-600">
            <tr>
              <th class="py-2 pr-4">ID</th>
              <th class="py-2 pr-4">Every</th>
              <th class="py-2 pr-4">Type</th>
              <th class="py-2 pr-4">Enabled</th>
              <th class="py-2 pr-4">Last Run</th>
              <th class="py-2 pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="sch"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id);

    async function refresh(){
      const r = await fetch('/api/backups2/', { credentials:'include' });
      const arr = await r.json();
      $('tbody').innerHTML = arr.map(b => row(b)).join('');
      const s = await (await fetch('/api/backups2/schedules', { credentials:'include' })).json();
      $('sch').innerHTML = s.map(x => srow(x)).join('');
    }
    function row(b){
      return `<tr>
        <td class="py-2 pr-4 font-mono">${b.id}</td>
        <td class="py-2 pr-4">${new Date(b.created).toLocaleString()}</td>
        <td class="py-2 pr-4">${b.type}</td>
        <td class="py-2 pr-4">${(b.sizeBytes/1024/1024).toFixed(1)} MB</td>
        <td class="py-2 pr-4">
          <button onclick="download('${b.id}')" class="px-2 py-1 rounded-lg border">Get link</button>
          <button onclick="delBackup('${b.id}')" class="px-2 py-1 rounded-lg border text-red-600">Delete</button>
        </td>
      </tr>`;
    }
    function srow(x){
      return `<tr>
        <td class="py-2 pr-4 font-mono">${x.id}</td>
        <td class="py-2 pr-4">${x.everyMinutes}m</td>
        <td class="py-2 pr-4">${x.type}</td>
        <td class="py-2 pr-4">${x.enabled ? 'Yes':'No'}</td>
        <td class="py-2 pr-4">${x.lastRunAt ? new Date(x.lastRunAt).toLocaleString() : '—'}</td>
        <td class="py-2 pr-4">
          <button onclick="toggle('${x.id}', ${!x.enabled})" class="px-2 py-1 rounded-lg border">${x.enabled?'Disable':'Enable'}</button>
          <button onclick="removeSch('${x.id}')" class="px-2 py-1 rounded-lg border text-red-600">Remove</button>
        </td>
      </tr>`;
    }
    async function delBackup(id){
      await fetch('/api/backups2/'+id, { method:'DELETE', credentials:'include' });
      refresh();
    }
    async function download(id){
      const r = await fetch('/api/backups2/download/'+id, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ ttlSec: 300 }) });
      const j = await r.json();
      alert('Signed link (5 min):\n'+ j.url);
    }
    async function toggle(id, enabled){
      await fetch('/api/backups2/schedules/'+id+'/toggle', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ enabled }) });
      refresh();
    }
    async function removeSch(id){
      await fetch('/api/backups2/schedules/'+id, { method:'DELETE', credentials:'include' });
      refresh();
    }

    $('btnRun').addEventListener('click', async ()=>{
      const type = $('type').value;
      await fetch('/api/backups2/run', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ type }) });
      refresh();
    });
    $('btnRefresh').addEventListener('click', refresh);
    $('btnAddSch').addEventListener('click', async ()=>{
      const everyMinutes = parseInt($('every').value, 10) || 60;
      const type = $('stype').value;
      await fetch('/api/backups2/schedules', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ everyMinutes, type }) });
      refresh();
    });

    refresh();
  </script>
</body>
</html>
