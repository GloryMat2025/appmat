<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Products – Modifiers (BM/EN)</title>
<link rel="stylesheet" href="brand.css">
<style>
  :root{ --bg:#0f172a; --card:#0b1020; --muted:#94a3b8; --fg:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1222,#0f172a);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0c1422)}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:28px;height:28px;object-fit:contain}
  h1{margin:0;font-size:1.05rem;letter-spacing:.2px}
  .right{display:flex;gap:10px;align-items:center}
  .pill{border:1px solid #223045;border-radius:999px;padding:6px 10px;background:#0c1627;color:#cfe7ff;cursor:pointer;user-select:none}
  .pill.active{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#07131c;border:0;font-weight:800}
  .cart{position:relative;display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid #223045;border-radius:10px;background:#0c1627}
  .badge{min-width:22px;height:22px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand-2));display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#07131c;font-size:.85rem}
  .wrap{max-width:1120px;margin:16px auto;padding:0 16px}
  .toolbar{display:grid;grid-template-columns:1fr;gap:10px;align-items:center;margin-bottom:12px}
  .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .search{flex:1;min-width:240px}
  .search input{width:100%;padding:10px 12px;border:1px solid #223045;border-radius:10px;background:#0c1627;color:#e5e7eb}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{background:linear-gradient(180deg,#0f172a,#0b1020);border:1px solid #1f2937;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .img{background:#0b1424;aspect-ratio:16/10;display:flex;align-items:center;justify-content:center;color:#7aa2c9;font-size:.9rem}
  .content{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:800}
  .price{font-weight:800}
  .muted{color:var(--muted);font-size:.92rem}
  .stock{font-size:.85rem;border:1px solid #243041;border-radius:8px;padding:2px 8px;display:inline-block}
  .stock.ok{background:#0f2b1b;border-color:#1b4d2d;color:#bbf7d0;font-weight:800}
  .stock.low{background:#3a2a0f;border-color:#5a4012;color:#fde68a;font-weight:800}
  .stock.none{background:#2a1620;border-color:#3b1e24;color:#fecaca;font-weight:800}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qty{display:inline-flex;align-items:center;border:1px solid #243041;border-radius:10px;overflow:hidden}
  .qty button{background:#0a1322;color:#dbeafe;border:0;width:36px;height:36px;font-weight:800;cursor:pointer}
  .qty input{width:48px;text-align:center;background:#0a1322;border:0;color:#e5e7eb;height:36px}
  .btn{border:1px solid #223045;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;background:#0c1627;color:#dbeafe}
  .btn.buy{background:linear-gradient(90deg, var(--ok), #a7f3d0);color:#06240f;border:0}
  .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.35)}
  footer{padding:14px;color:var(--muted);font-size:.9rem;text-align:center}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.open{display:flex}
  .sheet{background:#0b1020;border:1px solid #1f2937;border-radius:14px;max-width:520px;width:100%;padding:14px;max-height:90vh;overflow:auto}
  .sheet h3{margin:0 0 8px 0}
  .group{border:1px dashed #25334a;border-radius:10px;padding:10px;margin:10px 0}
  .opt{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
  .req{color:#fde68a;font-size:.9rem}
  .sheet .actions{justify-content:flex-end}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <img id="brandLogo" alt="Logo" src="" onerror="this.style.display='none'">
      <h1 data-i18n="title">Products</h1>
    </div>
    <div class="right">
      <div class="pill active" id="langEN">EN</div>
      <div class="pill" id="langBM">BM</div>
      <div class="cart" aria-label="Cart"><span data-i18n="common.cart">Cart</span><span class="badge" id="cartBadge">0</span></div>
    </div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="filters">
        <div>Outlet: <code id="outletId">JOH01</code></div>
        <div class="search"><input id="q" data-i18n-placeholder="common.search_placeholder" placeholder="Search products…" /></div>
      </div>
    </div>
    <div id="products" class="grid" aria-live="polite"></div>
  </div>

  <footer>Modifiers from <code>modifiers.json</code>. Brand via <code>brand.css</code>, logo via <code>localStorage.app.logoUrl</code>.</footer>

  <!-- Modifier Modal -->
  <div class="modal" id="modModal" role="dialog" aria-modal="true" aria-labelledby="modTitle">
    <div class="sheet">
      <h3 id="modTitle">Customize</h3>
      <div id="modBody"></div>
      <div class="actions" style="margin-top:10px">
        <button id="modCancel" class="btn">Cancel</button>
        <button id="modConfirm" class="btn buy">Add</button>
      </div>
    </div>
  </div>

<script src="i18n.loader.js"></script>
<script>
I18NLoader.init({ defaultLang:'en', fallback:'en', sources:{ en:'i18n/en.json', bm:'i18n/bm.json' } });
I18NLoader.extend('en', { title:'Products', customize:'Customize', required:'Required', cancel:'Cancel', add:'Add', selected:'selected' });
I18NLoader.extend('bm', { title:'Produk', customize:'Ubah suai', required:'Wajib', cancel:'Batal', add:'Tambah', selected:'dipilih' });

const PRODUCTS_URL = 'products_min.json';
const PRICEBOOK_URL = 'pricebook.csv';
const INVENTORY_URL = 'inventory.csv';
const MODS_URL = 'modifiers.json';
const DEFAULT_OUTLET = 'JOH01';

const fmtMYR = n => new Intl.NumberFormat('ms-MY',{style:'currency',currency:'MYR'}).format(n||0);
const $ = s => document.querySelector(s);
function shortTxt(s){ if(!s) return ''; const t=String(s).trim(); const d=t.indexOf('.'); return d>0&&d<120? t.slice(0,d+1): (t.length>120? t.slice(0,117)+'…': t); }

(function(){ try{ const u = JSON.parse(localStorage.getItem('app.logoUrl')||'null'); if(u) document.getElementById('brandLogo').src = u; }catch(_){} })();

/* Cart item: {id, qty, mods: {groupId: optionId}} */
const CART_KEY = 'demo.cart';
const Cart = {
  _r(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); } catch { return []; } },
  _w(v){ localStorage.setItem(CART_KEY, JSON.stringify(v)); badge(); },
  add(item){ const list=this._r();
    const idx=list.findIndex(x=>x.id===item.id && JSON.stringify(x.mods||{})===JSON.stringify(item.mods||{}));
    if(idx>=0) list[idx].qty=Math.min(999,(Number(list[idx].qty)||0)+(Number(item.qty)||0));
    else list.push(item);
    this._w(list);
  },
  count(){ return this._r().reduce((n,x)=>n+(Number(x.qty)||0),0); }
};
function badge(){ $('#cartBadge').textContent = Cart.count(); }

/* CSV Parser */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const hdrs = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).filter(Boolean).map(line=>{
    const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,''));
    const o = {}; hdrs.forEach((h,i)=> o[h] = (cols[i]??'').trim());
    if('price' in o) o.price = Number(o.price||0);
    if('on_hand' in o) o.on_hand = Number(o.on_hand||0);
    if('safety_stock' in o) o.safety_stock = Number(o.safety_stock||0);
    return o;
  });
}

/* Data stores */
let PRODUCTS=[], PRICEBOOK=[], INVENTORY=[], MODS=[];
function outletId(){ try{ const o=JSON.parse(localStorage.getItem('app.outlet')||'null'); return o?.id||DEFAULT_OUTLET; }catch{ return DEFAULT_OUTLET; } }
function effectivePrice(productId, outlet){
  const today = new Date().toISOString().slice(0,10);
  const rows = PRICEBOOK.filter(r => r.outlet_id===outlet && r.product_id===productId);
  for(const r of rows){
    const start=r.start_date||'0000-01-01', end=r.end_date||'9999-12-31';
    const avail = String(r.is_available||'true').toLowerCase()==='true';
    if(start<=today && today<=end) return { price:r.price, currency:r.currency||'MYR', available:avail };
  }
  if(rows[0]) return { price: rows[0].price, currency: rows[0].currency||'MYR', available: String(rows[0].is_available||'true').toLowerCase()==='true' };
  return { price:null, currency:'MYR', available:true };
}
function stockInfo(productId, outlet){
  const r = INVENTORY.find(x => x.outlet_id===outlet && x.product_id===productId);
  if(!r) return { on_hand:null, safety_stock:null };
  return { on_hand: Number(r.on_hand||0), safety_stock: Number(r.safety_stock||0) };
}
function stockBadge(inv){
  if(inv.on_hand==null) return '';
  if(inv.on_hand<=0) return `<span class="stock none">${I18NLoader.t('common.out_of_stock')}</span>`;
  if(inv.safety_stock!=null && inv.on_hand<=inv.safety_stock) return `<span class="stock low">${I18NLoader.t('common.low_stock')}: ${inv.on_hand}</span>`;
  return `<span class="stock ok">${I18NLoader.t('common.in_stock')}: ${inv.on_hand}</span>`;
}

/* UI */
function card(p){
  const isBM = I18NLoader.lang==='bm';
  const name = p[isBM?'name_bm':'name_en'] || p.name || '';
  const short = p[isBM?'short_desc_bm':'short_desc_en'] || p.short_desc || p[isBM?'desc_bm':'desc_en'] || '';
  const img = p.image || (p.images && p.images[0]);
  const oId = outletId();
  const eprice = effectivePrice(p.id, oId);
  const inv = stockInfo(p.id, oId);
  const canBuy = eprice.available && (inv.on_hand==null || inv.on_hand>0);
  const price = eprice.price!=null? eprice.price : (p.price ?? p.base_price ?? 0);
  const imgEl = img ? `<img alt="${name}" src="${img}" style="width:100%;height:100%;object-fit:cover" onerror="this.outerHTML='<div class=&quot;img&quot;>No Image</div>'">` : `<div class="img">No Image</div>`;
  return `
  <article class="card" data-id="${p.id}" data-canbuy="${canBuy}">
    ${imgEl}
    <div class="content">
      <div class="name">${name}</div>
      <div class="price">${fmtMYR(price)} ${!eprice.available ? `<span class="stock none">${I18NLoader.t('common.unavailable')}</span>`:''} ${stockBadge(inv)}</div>
      <p class="muted">${shortTxt(short)}</p>
      <div class="actions">
        <div class="qty" aria-label="Quantity">
          <button class="qminus" aria-label="Decrease">−</button>
          <input class="qinput" type="number" value="1" min="1" max="99" inputmode="numeric" />
          <button class="qplus" aria-label="Increase">+</button>
        </div>
        <button class="btn" data-action="add" ${!canBuy?'disabled':''} data-i18n="common.add_to_cart">${I18NLoader.t('common.add_to_cart')}</button>
        <button class="btn buy" data-action="buy" ${!canBuy?'disabled':''}>${I18NLoader.t('common.buy_now')}</button>
      </div>
    </div>
  </article>`;
}
function render(list){ const host=$('#products'); host.innerHTML=(list||[]).map(card).join(''); I18NLoader.apply(); badge(); $('#outletId').textContent = outletId(); }

/* Modal logic */
function openModifiers(productId, qty){
  const modal = $('#modModal'), body=$('#modBody'), title=$('#modTitle');
  const p = PRODUCTS.find(x=>x.id===productId) || {};
  title.textContent = `${I18NLoader.t('customize')} – ${I18NLoader.lang==='bm' ? (p.name_bm||p.name_en||p.name||productId) : (p.name_en||p.name_bm||p.name||productId)}`;

  const groups = (p.modifier_group_ids||[]).map(id => MODS.find(g=>g.id===id)).filter(Boolean);
  if(!groups.length){ // no mods, add directly
    Cart.add({ id: productId, qty, mods: {} });
    toast(I18NLoader.t('common.added_to_cart',{count:qty, name: title.textContent.replace(/^.*–\s*/,'')}),'ok');
    return;
  }

  body.innerHTML = groups.map(g => {
    const gName = I18NLoader.lang==='bm' ? (g.name_bm || g.name_en) : (g.name_en || g.name_bm);
    const req = g.required ? `<span class="req">(${I18NLoader.t('required')})</span>` : '';
    const opts = (g.options||[]).map(o => {
      const oName = I18NLoader.lang==='bm' ? (o.name_bm || o.name_en) : (o.name_en || o.name_bm);
      const delta = o.price_delta ? ` + ${fmtMYR(o.price_delta)}` : '';
      return `<label class="opt"><span>${oName}<small class="muted">${delta}</small></span><input type="radio" name="${g.id}" value="${o.id}"></label>`;
    }).join('');
    return `<div class="group"><div><strong>${gName}</strong> ${req}</div>${opts}</div>`;
  }).join('');

  modal.classList.add('open');

  const confirm = $('#modConfirm'), cancel=$('#modCancel');
  function close(){ modal.classList.remove('open'); confirm.onclick=null; cancel.onclick=null; }
  cancel.onclick = close;
  confirm.textContent = I18NLoader.t('add');
  cancel.textContent = I18NLoader.t('cancel');

  confirm.onclick = () => {
    const selection = {};
    let valid = true;
    for(const g of groups){
      const chosen = body.querySelector(`input[name="${g.id}"]:checked`)?.value;
      if(g.required && !chosen){ valid=false; break; }
      if(chosen) selection[g.id]=chosen;
    }
    if(!valid){ toast(I18NLoader.lang==='bm' ? 'Sila pilih pilihan wajib.' : 'Please choose required options.'); return; }
    Cart.add({ id: productId, qty, mods: selection });
    close();
    toast(I18NLoader.t('common.added_to_cart',{count:qty, name: title.textContent.replace(/^.*–\s*/,'')}),'ok');
  };
}

/* Data load + interactions */
(async function init(){
  try {
    const [pr, pb, inv, md] = await Promise.all([
      fetch(PRODUCTS_URL), fetch(PRICEBOOK_URL), fetch(INVENTORY_URL), fetch(MODS_URL)
    ]);
    PRODUCTS = await pr.json();
    PRICEBOOK = parseCSV(await pb.text());
    INVENTORY = parseCSV(await inv.text());
    MODS = (await md.json()).modifier_groups || [];
    render(PRODUCTS);
  }catch(e){
    console.error(e);
    $('#products').innerHTML = `<div class="muted" data-i18n="common.empty">${I18NLoader.t('common.empty')}</div>`;
  }
})();

document.getElementById('q').addEventListener('input', e => {
  const s = e.target.value.trim().toLowerCase();
  const filtered = !s ? PRODUCTS : PRODUCTS.filter(p => [p.name,p.name_en,p.name_bm,p.short_desc,p.short_desc_en,p.short_desc_bm].join(' ').toLowerCase().includes(s));
  render(filtered);
});

document.getElementById('products').addEventListener('click', (e)=>{
  const card = e.target.closest('.card'); if(!card) return;
  const id = card.getAttribute('data-id');
  const canBuy = card.getAttribute('data-canbuy') === 'true';
  const qtyInput = card.querySelector('.qinput');
  const getQty = () => Math.max(1, Math.min(99, parseInt(qtyInput.value || '1', 10)));
  if(e.target.classList.contains('qminus')) qtyInput.value = Math.max(1, getQty()-1);
  if(e.target.classList.contains('qplus'))  qtyInput.value = Math.min(99, getQty()+1);
  const action = e.target.getAttribute('data-action');
  if((action === 'add' || action==='buy') && canBuy){
    openModifiers(id, getQty());
  }
});

window.addEventListener('i18n:change', ()=> render(PRODUCTS));

/* Toast */
function toast(msg, type){
  const t=document.createElement('div'); t.textContent=msg;
  t.style.position='fixed'; t.style.right='14px'; t.style.bottom='14px'; t.style.maxWidth='70vw';
  t.style.padding='10px 12px'; t.style.borderRadius='10px'; t.style.fontWeight='700'; t.style.border='1px solid #223045';
  t.style.background = type==='ok' ? 'linear-gradient(90deg, var(--ok), #a7f3d0)' : 'linear-gradient(90deg, var(--brand), var(--brand-2))';
  t.style.color='#06131a'; t.style.boxShadow='0 8px 24px rgba(0,0,0,.35)';
  document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0'; t.style.transition='opacity .3s';}, 1200); setTimeout(()=>t.remove(), 1550);
}
</script>
</body>
</html>
