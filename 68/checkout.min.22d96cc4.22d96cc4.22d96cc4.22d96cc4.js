!function(){const e=window.CartState.fmt,t={list:document.getElementById("sumList"),subtotal:document.getElementById("sumSubtotal"),itemsCount:document.getElementById("sumItemsCount"),bankChosen:document.getElementById("bankChosen"),btnChooseBank:document.getElementById("btnChooseBank"),form:document.getElementById("checkoutForm"),btnApplyPromo:document.getElementById("btnApplyPromo"),btnClearPromo:document.getElementById("btnClearPromo"),promoApplied:document.getElementById("promoApplied"),live:document.getElementById("checkoutLive"),pay:document.getElementById("btnPay"),tSubtotal:document.getElementById("tSubtotal"),tDiscount:document.getElementById("tDiscount"),tTax:document.getElementById("tTax"),tDelivery:document.getElementById("tDelivery"),tTotal:document.getElementById("tTotal"),rowDiscount:document.getElementById("rowDiscount"),rowDelivery:document.getElementById("rowDelivery")},o={WELCOME10:{type:"percent",value:10,desc:"10% off first order"},FREEDRINK:{type:"flat",value:3.5,desc:"Free drink value RM 3.50"}},n="checkout:bank",a="checkout:promo",r="checkout:draft:v1";function saveDraft(){if(!t.form)return;const e=new FormData(t.form),o={};e.forEach((e,t)=>o[t]=String(e)),localStorage.setItem(r,JSON.stringify(o))}const l=JSON.parse(localStorage.getItem(n)||"null");l&&(t.bankChosen.textContent=l.name);const i=function readDraft(){try{return JSON.parse(localStorage.getItem(r)||"{}")}catch{return{}}}();t.form&&i&&(["name","email","phone","notes"].forEach(e=>{i[e]&&t.form.elements[e]&&(t.form.elements[e].value=i[e])}),i.promo&&t.form.elements.promo&&(t.form.elements.promo.value=i.promo));const s=JSON.parse(localStorage.getItem("gf_pickup_outlet")||"null"),m=JSON.parse(localStorage.getItem("gf_delivery_address")||"null"),c=s?"pickup":m?"delivery":"unspecified";function announce(e){t.live&&(t.live.textContent="",setTimeout(()=>{t.live.textContent=e},10))}function setError(e,o){const n=document.querySelector(`[data-err-for="${e}"]`),a=t.form?.elements[e];n&&a&&(n.classList.toggle("hidden",!o),a.setAttribute("aria-invalid",o?"true":"false"))}function computeTotals(){const e=window.CartState.get(),t=window.CartState.subtotal(),n=function getPromo(){const e=(localStorage.getItem(a)||"").toUpperCase();return e&&o[e]?{code:e,...o[e]}:null}();let r=0;n&&("percent"===n.type?r=t*(n.value/100):"flat"===n.type&&(r=Math.min(t,n.value)));let l=0,i=0;if(window.Loyalty){const e=Math.max(0,t-r),o=window.Loyalty.applied();l=function(){const t=e,n=Math.floor(100*t);return Math.min(o,n)}(),i=+(l/100).toFixed(2)}const s=Math.max(0,t-r-i),m=+(.06*s).toFixed(2),d="delivery"===c?4:0,u=+(s+m+d).toFixed(2);return{items:e,subtotal:t,discount:+r.toFixed(2),tax:m,delivery:d,total:u,promo:n,loyalty:{points:l,amount:i}}}function renderSummary(){const{items:o,subtotal:n,promo:a,discount:r,tax:l,delivery:i,total:s,loyalty:m}=computeTotals();t.list.innerHTML=o.map(t=>`<div class="flex items-center justify-between text-sm"><span class="truncate">${t.name} × ${t.qty}</span><span class="font-medium">${e(t.qty*t.price)}</span></div>`).join(""),t.subtotal.textContent=e(n),t.itemsCount&&(t.itemsCount.textContent=`${o.reduce((e,t)=>e+t.qty,0)} item(s)`),t.tSubtotal.textContent=e(n),t.tTax.textContent=e(l),t.tTotal.textContent=e(s),t.tDelivery.textContent=e(i),t.rowDelivery.hidden=0===i,a?(t.rowDiscount.hidden=!1,t.tDiscount.textContent=`− ${e(r)}`,t.promoApplied.classList.remove("hidden"),t.promoApplied.textContent=`${a.code} applied: ${a.desc}`,t.btnClearPromo.classList.remove("hidden")):(t.rowDiscount.hidden=!0,t.promoApplied.classList.add("hidden"),t.btnClearPromo.classList.add("hidden"));let c=document.getElementById("rowLoyalty");m&&m.points>0?(c||(c=document.createElement("div"),c.id="rowLoyalty",c.className="flex items-center justify-between text-sm mt-1",t.tTotal.parentElement?.insertBefore(c,t.tTax.parentElement)),c.innerHTML=`<span>Loyalty (−${m.points}pts)</span><span class="font-medium">− ${e(m.amount)}</span>`):c&&c.remove()}renderSummary(),t.btnApplyPromo?.addEventListener("click",()=>{const e=t.form.elements.promo.value.trim(),n=function applyPromo(e){const t=e.toUpperCase();return o[t]?(localStorage.setItem(a,t),o[t]):null}(e);setError("promo",!n&&!!e),n&&announce(`Promo ${e} applied`),renderSummary(),saveDraft()}),t.btnClearPromo?.addEventListener("click",()=>{!function clearPromo(){localStorage.removeItem(a)}(),t.form.elements.promo.value="",renderSummary(),announce("Promo removed"),saveDraft()}),t.form?.addEventListener("input",e=>{["name","email","phone","notes","promo"].includes(e.target.name)&&(saveDraft(),["name","email","phone"].includes(e.target.name)&&setError(e.target.name,!1))});const d=[{code:"MB2U",name:"Maybank"},{code:"CIMB",name:"CIMB"},{code:"PBB",name:"Public Bank"},{code:"HLB",name:"Hong Leong Bank"},{code:"RHB",name:"RHB"},{code:"AMB",name:"AmBank"},{code:"BSN",name:"BSN"},{code:"UOB",name:"UOB"},{code:"HSBC",name:"HSBC"},{code:"SCB",name:"Standard Chartered"},{code:"OCBC",name:"OCBC"},{code:"BIMB",name:"Bank Islam"},{code:"BRB",name:"Bank Rakyat"},{code:"AFF",name:"Affin Bank"}];function afterSuccess(e,o){const n="checkout:orders",r=JSON.parse(localStorage.getItem(n)||"[]");r.push(e),localStorage.setItem(n,JSON.stringify(r));try{window.Missions&&window.Missions.recordOrder(e)}catch(e){console.warn("Mission record failed",e)}try{if(window.Loyalty){window.Loyalty.spendApplied();const t=5,o=Math.floor(e.subtotal*t);o>0&&window.Loyalty.addEarned(o)}}catch(e){console.warn("Loyalty update failed",e)}try{const t=JSON.parse(localStorage.getItem("orderHistory")||"[]"),o={id:e.id,created:e.created,readyAt:e.created+3e5,completedAt:e.created+6e5,status:"preparing",items:e.items.map(e=>({id:e.id,name:e.name||e.id,price:e.price,qty:e.qty})),subtotal:e.subtotal,tax:e.tax,total:e.total};t.push(o),localStorage.setItem("orderHistory",JSON.stringify(t))}catch(e){}window.CartState.clear(),localStorage.removeItem(a),saveDraft(),t.pay.textContent=o?"Queued":"Paid",setTimeout(()=>{location.href="./index.html"},900)}t.btnChooseBank?.addEventListener("click",async()=>{if(!window.openPopup)return alert("Popup module missing");const e=await window.openPopup("bank-select",{banks:d});e&&(localStorage.setItem(n,JSON.stringify(e)),t.bankChosen.textContent=e.name,announce(`Bank ${e.name} selected`))}),t.pay?.addEventListener("click",async function submitOrder(){if(!function validate(){if(!t.form)return!1;let e=!0;return["name","email","phone"].forEach(o=>{const n=t.form.elements[o],a=!!n.value&&(!n.checkValidity||n.checkValidity());setError(o,!a),a||(e=!1)}),e}())return void announce("Please fix validation errors");if(0===window.CartState.get().length)return alert("Your cart is empty.");if(!JSON.parse(localStorage.getItem(n)||"null"))return alert("Please choose a bank.");t.pay.disabled=!0,t.pay.textContent="Processing…";const e=function buildOrder(){const e=computeTotals(),o=JSON.parse(localStorage.getItem(n)||"null"),a=new FormData(t.form),r={name:a.get("name")||"",email:a.get("email")||"",phone:a.get("phone")||"",notes:a.get("notes")||""};let l=null;try{const e=JSON.parse(localStorage.getItem("gf_pickup_outlet")||"null");e&&e.id&&(l=e.id)}catch{}return{id:"ORD-"+Date.now().toString(36),created:Date.now(),status:"pending",items:e.items,subtotal:e.subtotal,discount:e.discount,loyalty:e.loyalty,tax:e.tax,delivery:e.delivery,total:e.total,payment:{method:"fpx",bank:o?o.code:null},fulfilment:c,customer:r,promo:e.promo?e.promo.code:null,outletId:l}}();try{if(window.__offlineQueue&&!navigator.onLine)window.__offlineQueue.enqueue({type:"placeOrder",order:e}),announce("Order queued for sync when online"),afterSuccess(e,!0);else if(window.__offlineQueue){window.__offlineQueue.enqueue({type:"placeOrder",order:e});try{await window.__offlineQueue.replay()}catch{}announce("Order submitted"),afterSuccess(e,!1)}else await new Promise(e=>setTimeout(e,700)),announce("Order submitted"),afterSuccess(e,!1)}catch(e){console.error(e),alert("Failed submitting order"),t.pay.disabled=!1,t.pay.textContent="Pay Now"}})}();