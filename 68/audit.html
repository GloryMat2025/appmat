<!doctype html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audit Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chip{font-size:12px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body class="h-full text-slate-800">
  <header class="border-b bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold">Audit Explorer</h1>
      <div class="flex items-center gap-2">
        <a id="btnCsv" class="px-3 py-1.5 rounded-lg border" href="#">Export CSV</a>
        <button id="btnRefresh" class="px-3 py-1.5 rounded-lg border">Refresh</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Filters -->
    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <h2 class="text-sm font-semibold mb-2">Filters</h2>
      <div class="grid md:grid-cols-6 gap-2 items-end">
        <input id="q" class="border rounded-lg px-3 py-2" placeholder="Search (email, path, action, meta)">
        <input id="actor" class="border rounded-lg px-3 py-2" placeholder="Actor (email or user id)">
        <input id="action" class="border rounded-lg px-3 py-2" placeholder="Action contains...">
        <input id="ip" class="border rounded-lg px-3 py-2" placeholder="IP">
        <input id="from" type="datetime-local" class="border rounded-lg px-3 py-2" placeholder="From">
        <input id="to" type="datetime-local" class="border rounded-lg px-3 py-2" placeholder="To">
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button id="apply" class="px-3 py-1.5 rounded-lg bg-sky-600 text-white">Apply</button>
        <button id="clear" class="px-3 py-1.5 rounded-lg border">Clear</button>
        <span class="text-xs text-slate-500 ml-auto">Tips: click a cell to copy · click an action chip to filter</span>
      </div>
    </section>

    <!-- Summary -->
    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <h2 class="text-sm font-semibold mb-2">Summary</h2>
      <div id="summary" class="grid md:grid-cols-4 gap-3 text-sm"></div>
      <div class="mt-3">
        <canvas id="timeline" height="140"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold">Results</h2>
        <div class="text-xs text-slate-500">up to <span id="limitLbl">100</span> rows</div>
      </div>
      <div class="mt-3 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left bg-slate-50">
            <tr>
              <th class="px-2 py-1">Time</th>
              <th class="px-2 py-1">Actor</th>
              <th class="px-2 py-1">IP</th>
              <th class="px-2 py-1">Action</th>
              <th class="px-2 py-1">Path</th>
              <th class="px-2 py-1">Status</th>
              <th class="px-2 py-1">Dur (ms)</th>
              <th class="px-2 py-1">Meta</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button id="more" class="px-3 py-1.5 rounded-lg border">Load more</button>
        <span id="count" class="text-xs text-slate-500"></span>
      </div>
    </section>
  </main>

  <script>
    // Minimal chart (no libs): simple counts per 5-minute buckets using canvas.
    function drawTimeline(data){
      const canvas = document.getElementById('timeline');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width, canvas.height);
      const w = canvas.width, h = canvas.height, pad=20;
      const keys = Object.keys(data).sort();
      if (!keys.length) return;
      const max = Math.max(...keys.map(k=>data[k]));
      // axes
      ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.stroke();
      // line
      ctx.beginPath();
      keys.forEach((k,i)=>{
        const x = pad + (i/(keys.length-1))*(w-2*pad);
        const y = h-pad - (data[k]/max)*(h-2*pad);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    const $ = id => document.getElementById(id);
    let nextCursor = null;
    let limit = 100;

    function qi(id){ const v=$(id).value.trim(); return v || null; }
    function params(){
      const p = { q:qi('q'), actor:qi('actor'), action:qi('action'), ip:qi('ip'), from:qi('from'), to:qi('to'), limit };
      const qs = Object.entries(p).filter(([_,v])=>v).map(([k,v])=>k+'='+encodeURIComponent(v)).join('&');
      return qs;
    }

    function setCsvHref(){
      $('btnCsv').href = '/api/audit/export.csv?'+params();
    }

    function cell(text, cls=''){
      const td = document.createElement('td'); td.className='px-2 py-1 align-top '+cls;
      const span = document.createElement('span'); span.textContent = text;
      span.addEventListener('click', ()=>{ navigator.clipboard.writeText(String(text||'')); });
      td.appendChild(span); return td;
    }
    function chipAction(text){
      const span = document.createElement('span'); span.className='chip mono cursor-pointer'; span.textContent=text||'';
      span.addEventListener('click', ()=>{ $('action').value=text||''; apply(); });
      return span;
    }
    function renderRows(arr){
      const tb = $('rows');
      arr.forEach(r => {
        const tr = document.createElement('tr');
        tr.appendChild(cell(new Date(r.ts).toLocaleString()));
        tr.appendChild(cell(r.email || r.user_id || '—'));
        tr.appendChild(cell(r.ip || '—'));
        const tdA = cell(''); tdA.appendChild(chipAction(r.action)); tr.appendChild(tdA);
        tr.appendChild(cell(r.path || '—'));
        tr.appendChild(cell(String(r.status)));
        tr.appendChild(cell(String(r.duration_ms||0)));
        const meta = document.createElement('td'); meta.className='px-2 py-1 mono text-xs max-w-[360px] break-all';
        meta.textContent = JSON.stringify(r.meta||{});
        tr.appendChild(meta);
        tb.appendChild(tr);
      });
    }

    async function fetchSummary(){
      const r = await fetch('/api/audit/summary', { credentials:'include' });
      if (!r.ok) return;
      const s = await r.json();
      $('summary').innerHTML = \`
        <div class="border rounded-xl p-3"><div class="text-xs text-slate-500">Total entries</div><div class="text-xl font-semibold">\${s.count}</div></div>
        <div class="border rounded-xl p-3"><div class="text-xs text-slate-500">Errors (>=400)</div><div class="text-xl font-semibold">\${s.errors}</div></div>
        <div class="border rounded-xl p-3"><div class="text-xs text-slate-500">Top roles</div><div class="text-sm">\${Object.entries(s.byRole||{}).map(([k,v])=>k+': '+v).join(', ') || '—'}</div></div>
        <div class="border rounded-xl p-3"><div class="text-xs text-slate-500">Top actions</div><div class="text-sm">\${Object.entries(s.byAction||{}).map(([k,v])=>k+': '+v).join(', ') || '—'}</div></div>
      \`;
    }

    async function apply(){
      $('rows').innerHTML=''; nextCursor=null;
      limit = 100; $('limitLbl').textContent = limit;
      setCsvHref();
      await loadMore();
    }

    async function loadMore(){
      const qs = params() + (nextCursor ? '&cursor='+encodeURIComponent(nextCursor) : '');
      const r = await fetch('/api/audit?'+qs, { credentials:'include' });
      const j = await r.json();
      renderRows(j.rows||[]);
      $('count').textContent = (document.querySelectorAll('#rows tr').length)+' rows';
      nextCursor = j.nextCursor || null;
      if (!nextCursor) $('more').setAttribute('disabled','true'); else $('more').removeAttribute('disabled');

      // Build simple timeline buckets (5-min) from current table
      const all = Array.from(document.querySelectorAll('#rows tr')).map(tr => new Date(tr.children[0].innerText).getTime());
      const buckets = {};
      all.forEach(t => {
        const b = Math.floor(t / (5*60*1000)) * (5*60*1000);
        buckets[b] = (buckets[b]||0) + 1;
      });
      drawTimeline(buckets);
    }

    $('apply').addEventListener('click', apply);
    $('clear').addEventListener('click', ()=>{ ['q','actor','action','ip','from','to'].forEach(id => $(id).value=''); apply(); });
    $('more').addEventListener('click', loadMore);
    $('btnRefresh').addEventListener('click', ()=>{ fetchSummary(); apply(); });

    fetchSummary();
    apply();
  </script>
</body>
</html>
